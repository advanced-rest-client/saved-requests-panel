<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>saved-requests-panel test</title>
  <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../chance/dist/chance.min.js"></script>
  <link rel="import" href="../../app-pouchdb/pouchdb.html">
  <link rel="import" href="../../arc-models/request-model.html">
  <link rel="import" href="../../arc-models/project-model.html">
  <link rel="import" href="../../arc-data-generator/arc-data-generator.html">
  <link rel="import" href="../saved-requests-panel.html">
</head>

<body>
  <test-fixture id="Basic">
    <template>
      <saved-requests-panel no-auto no-auto-projects></saved-requests-panel>
    </template>
  </test-fixture>
  <test-fixture id="Models">
    <template>
      <request-model></request-model>
      <project-model></project-model>
      <saved-requests-panel></saved-requests-panel>
    </template>
  </test-fixture>

  <script>
  /* global DataGenerator, chance */
  function doneAfterQuery(element, done) {
    element.addEventListener('querying-changed', function f(e) {
      if (e.detail.value) {
        return;
      }
      element.removeEventListener('querying-changed', f);
      flush(() => done());
    });
  }

  suite('_computeA11yCommand()', () => {
    let element;
    setup(function() {
      element = fixture('Basic');
    });

    test('Returns passed letter with CMD/CTRL', () => {
      const result = element._computeA11yCommand('s');
      assert.isTrue(/(meta|ctrl)\+s/.test(result));
    });
  });

  suite('notifyResize()', () => {
    test('Do nothing when DOM is not initialized', () => {
      const element = fixture('Basic');
      element.notifyResize();
    });

    test('Calls list\'s notifyResize', (done) => {
      const element = fixture('Basic');
      flush(() => {
        const list = element.shadowRoot.querySelector('saved-panel-list');
        let called = false;
        list.notifyResize = () => called = true;
        element.notifyResize();
        assert.isTrue(called);
        done();
      });
    });
  });

  suite('_computeListHidden()', () => {
    let element;
    suiteSetup(() => {
      element = fixture('Basic');
    });

    test('Returns false when isSearch is true', () => {
      let result = element._computeListHidden(true, true);
      assert.isFalse(result);
      result = element._computeListHidden(false, true);
      assert.isFalse(result);
    });

    test('Returns false when hasRequests is true', () => {
      let result = element._computeListHidden(true);
      assert.isFalse(result);
    });

    test('Returns true when hasRequests is false', () => {
      let result = element._computeListHidden(false);
      assert.isTrue(result);
    });
  });

  suite('_navigateHandler()', () => {
    let element;
    setup(() => {
      element = fixture('Basic');
    });

    test('Sets detailsOpened to false', () => {
      element.detailsOpened = true;
      element._navigateHandler();
      assert.isFalse(element.detailsOpened);
    });
  });

  suite('_onDetails()', () => {
    let element;
    let eData;
    setup((done) => {
      element = fixture('Basic');
      eData = {
        detail: {
          request: DataGenerator.generateSavedItem()
        }
      };
      flush(() => done());
    });

    test('Sets request on request details dialog', () => {
      element._onDetails(eData);
      assert.isTrue(eData.detail.request === element.$.requestDetails.request);
    });

    test('Opens request details dialog', () => {
      element._onDetails(eData);
      assert.isTrue(element.detailsOpened);
    });
  });

  suite('_loadRequestDetails()', () => {
    let element;
    setup((done) => {
      element = fixture('Basic');
      flush(() => {
        element.$.requestDetails.request = {
          _id: 'test'
        };
        done();
      });
    });

    test('Dispatches "navigate" event', () => {
      const spy = sinon.spy();
      element.addEventListener('navigate', spy);
      element._loadRequestDetails();
      assert.isTrue(spy.called);
    });

    test('The event has base', () => {
      let data;
      element.addEventListener('navigate', function f(e) {
        element.removeEventListener('navigate', f);
        data = e.detail;
      });
      element._loadRequestDetails();
      assert.equal(data.base, 'request');
    });

    test('The event has type', () => {
      let data;
      element.addEventListener('navigate', function f(e) {
        element.removeEventListener('navigate', f);
        data = e.detail;
      });
      element._loadRequestDetails();
      assert.equal(data.type, 'saved');
    });

    test('The event has id', () => {
      let data;
      element.addEventListener('navigate', function f(e) {
        element.removeEventListener('navigate', f);
        data = e.detail;
      });
      element._loadRequestDetails();
      assert.equal(data.id, 'test');
    });

    test('The event bubbles', () => {
      let data;
      element.addEventListener('navigate', function f(e) {
        element.removeEventListener('navigate', f);
        data = e;
      });
      element._loadRequestDetails();
      assert.isTrue(data.bubbles);
    });

    test('The event is composed', () => {
      let data;
      element.addEventListener('navigate', function f(e) {
        element.removeEventListener('navigate', f);
        data = e;
      });
      element._loadRequestDetails();
      assert.isTrue(data.composed);
    });

    test('The event is cancelable', () => {
      let data;
      element.addEventListener('navigate', function f(e) {
        element.removeEventListener('navigate', f);
        data = e;
      });
      element._loadRequestDetails();
      assert.isTrue(data.cancelable);
    });
  });

  suite('_searchHandler()', () => {
    let element;
    let arg;
    setup((done) => {
      element = fixture('Basic');
      arg = {
        target: {
          value: 'test'
        }
      };
      flush(() => done());
    });

    test('Calls query() function', () => {
      let called = false;
      element.query = () => called = true;
      element._searchHandler(arg);
      assert.isTrue(called);
    });

    test('Passes value to query function', () => {
      let value;
      element.query = (input) => value = input;
      element._searchHandler(arg);
      assert.equal(value, 'test');
    });
  });

  suite('_deleteSelected()', () => {
    let element;
    setup((done) => {
      element = fixture('Basic');
      flush(() => done());
    });

    test('Closes the selection menu', () => {
      let called = false;
      element._closeSelectionMenu = () => called = true;
      element._deleteSelected();
      assert.isTrue(called);
    });

    test('Calls delete function', () => {
      const arr = ['a', 'b', 'c'];
      element.selectedItems = arr;
      let value;
      element._delete = (input) => value = input;
      element._deleteSelected();
      assert.deepEqual(value, arr);
    });

    test('Does nothing when no selection', () => {
      let called = false;
      element._delete = () => called = true;
      element._deleteSelected();
      assert.isFalse(called);
    });
  });

  suite('_deleteRequestDetails()', () => {
    let element;
    setup((done) => {
      element = fixture('Basic');
      flush(() => {
        element.$.requestDetails.request = DataGenerator.generateSavedItem();
        done();
      });
    });

    test('Calls delete function', () => {
      let value;
      element._delete = (input) => value = input;
      element._deleteRequestDetails();
      assert.typeOf(value, 'array');
      assert.lengthOf(value, 1);
    });

    test('Sets detailsOpened to false', () => {
      element.detailsOpened = true;
      element._delete = () => {};
      element._deleteRequestDetails();
      assert.isFalse(element.detailsOpened);
    });
  });

  suite('_dispatchDelete()', () => {
    let element;
    let list;
    setup(() => {
      element = fixture('Basic');
      list = DataGenerator.generateRequests({
        requestsSize: 5
      });
    });

    test('Dispatches request-objects-deleted event', () => {
      const spy = sinon.spy();
      element.addEventListener('request-objects-deleted', spy);
      element._dispatchDelete(list);
      assert.isTrue(spy.called);
    });

    test('The event bubbles', () => {
      let data;
      element.addEventListener('request-objects-deleted', function f(e) {
        element.removeEventListener('request-objects-deleted', f);
        data = e;
      });
      element._dispatchDelete(list);
      assert.isTrue(data.bubbles);
    });

    test('The event is composed', () => {
      let data;
      element.addEventListener('request-objects-deleted', function f(e) {
        element.removeEventListener('request-objects-deleted', f);
        data = e;
      });
      element._dispatchDelete(list);
      assert.isTrue(data.composed);
    });

    test('The event is cancelable', () => {
      let data;
      element.addEventListener('request-objects-deleted', function f(e) {
        element.removeEventListener('request-objects-deleted', f);
        data = e;
      });
      element._dispatchDelete(list);
      assert.isTrue(data.cancelable);
    });

    test('The event has "detail.type"', () => {
      let data;
      element.addEventListener('request-objects-deleted', function f(e) {
        element.removeEventListener('request-objects-deleted', f);
        data = e.detail;
      });
      element._dispatchDelete(list);
      assert.equal(data.type, 'saved');
    });

    test('The event has "detail.items"', () => {
      let data;
      element.addEventListener('request-objects-deleted', function f(e) {
        element.removeEventListener('request-objects-deleted', f);
        data = e.detail;
      });
      element._dispatchDelete(list);
      assert.typeOf(data.items, 'array');
      assert.lengthOf(data.items, 5);
    });

    test('The "detail.items" are IDs', () => {
      let data;
      element.addEventListener('request-objects-deleted', function f(e) {
        element.removeEventListener('request-objects-deleted', f);
        data = e.detail;
      });
      element._dispatchDelete(list);
      assert.typeOf(data.items[0], 'string');
    });
  });

  suite('_delete()', () => {
    teardown(() => {
      return DataGenerator.destroySavedRequestData();
    });

    let element;
    setup((done) => {
      DataGenerator.insertSavedRequestData({
        requestsSize: 5
      })
      .then(() => {
        element = fixture('Models')[2];
        doneAfterQuery(element, done);
      });
    });

    test('Dispatches request-objects-deleted event', () => {
      const spy = sinon.spy();
      element.addEventListener('request-objects-deleted', spy);
      const p = element._delete(element.requests.slice(0, 2));
      assert.isTrue(spy.called);
      return p;
    });

    test('Sets _latestDeleted', () => {
      return element._delete(element.requests.slice(0, 2))
      .then(() => {
        assert.typeOf(element._latestDeleted, 'array');
        assert.lengthOf(element._latestDeleted, 2);
      });
    });

    test('_latestDeleted has _id and _rev', () => {
      return element._delete(element.requests.slice(0, 2))
      .then(() => {
        const item = element._latestDeleted[0];
        assert.typeOf(item._id, 'string');
        assert.typeOf(item._rev, 'string');
      });
    });

    test('Opens delete confirmation toast', () => {
      return element._delete(element.requests.slice(0, 2))
      .then(() => {
        assert.isTrue(element.$.deleteToast.opened);
      });
    });
  });

  suite('_dispatchUndelete()', () => {
    let element;
    let list;
    setup(() => {
      element = fixture('Basic');
      list = [];
      for (let i = 0; i < 5; i++) {
        list[i] = {
          _id: chance.guid({version: 5}),
          _rev: chance.guid({version: 5})
        };
      }
    });

    test('Dispatches request-objects-undeleted event', () => {
      const spy = sinon.spy();
      element.addEventListener('request-objects-undeleted', spy);
      element._dispatchUndelete(list);
      assert.isTrue(spy.called);
    });

    test('The event bubbles', () => {
      let data;
      element.addEventListener('request-objects-undeleted', function f(e) {
        element.removeEventListener('request-objects-undeleted', f);
        data = e;
      });
      element._dispatchUndelete(list);
      assert.isTrue(data.bubbles);
    });

    test('The event is composed', () => {
      let data;
      element.addEventListener('request-objects-undeleted', function f(e) {
        element.removeEventListener('request-objects-undeleted', f);
        data = e;
      });
      element._dispatchUndelete(list);
      assert.isTrue(data.composed);
    });

    test('The event is cancelable', () => {
      let data;
      element.addEventListener('request-objects-undeleted', function f(e) {
        element.removeEventListener('request-objects-undeleted', f);
        data = e;
      });
      element._dispatchUndelete(list);
      assert.isTrue(data.cancelable);
    });

    test('The event has "detail.type"', () => {
      let data;
      element.addEventListener('request-objects-undeleted', function f(e) {
        element.removeEventListener('request-objects-undeleted', f);
        data = e.detail;
      });
      element._dispatchUndelete(list);
      assert.equal(data.type, 'saved');
    });

    test('The event has "detail.items"', () => {
      let data;
      element.addEventListener('request-objects-undeleted', function f(e) {
        element.removeEventListener('request-objects-undeleted', f);
        data = e.detail;
      });
      element._dispatchUndelete(list);
      assert.typeOf(data.items, 'array');
      assert.lengthOf(data.items, 5);
    });

    test('The "detail.items" has _id and _rev', () => {
      let data;
      element.addEventListener('request-objects-undeleted', function f(e) {
        element.removeEventListener('request-objects-undeleted', f);
        data = e.detail;
      });
      element._dispatchUndelete(list);
      assert.typeOf(data.items[0]._id, 'string');
      assert.typeOf(data.items[0]._rev, 'string');
    });
  });

  suite.only('revertDeleted()', () => {
    teardown(() => {
      return DataGenerator.destroySavedRequestData();
    });

    let element;
    setup((done) => {
      DataGenerator.insertSavedRequestData({
        requestsSize: 5
      })
      .then(() => {
        element = fixture('Models')[2];
        doneAfterQuery(element, done);
      });
    });

    test('Do nothing when delete was not called before', function() {
      return element.revertDeleted(); // no error is thrown
    });

    test('Closes delete confirmation toast', function() {
      return element._delete(element.requests.slice(0, 2))
      .then(() => {
        const promise = element.revertDeleted();
        assert.isFalse(element.$.deleteToast.opened);
        return promise;
      });
    });

    test('Dispatches request-objects-undeleted event', function() {
      const spy = sinon.spy();
      element.addEventListener('request-objects-undeleted', spy);
      return element._delete(element.requests.slice(0, 2))
      .then(() => {
        const promise = element.revertDeleted();
        assert.isTrue(spy.calledOnce);
        return promise;
      });
    });

    test('Undeleted restores items to the list', function() {
      const deleted = [element.requests[2], element.requests[3]];
      const sizeBefore = element.requests.length;
      return element._delete(deleted)
      .then(() => {
        assert.notEqual(element.requests.length, sizeBefore);
        return element.revertDeleted();
      })
      .then(() => {
        assert.equal(element.requests.length, sizeBefore);
      });
    });
  });

  suite('DOM manipulation', () => {
    suite('No data', () => {
      suiteSetup(() => {
        return DataGenerator.destroySavedRequestData();
      });

      let element;
      setup((done) => {
        element = fixture('Models')[2];
        doneAfterQuery(element, done);
      });

      test('hasRequests is false', () => {
        assert.isFalse(element.hasRequests);
      });

      test('empty message is rendered', () => {
        const node = element.shadowRoot.querySelector('.empty-info');
        assert.ok(node);
      });

      test('The list is hidden', () => {
        const list = element.shadowRoot.querySelector('saved-panel-list');
        assert.isTrue(list.hasAttribute('hidden'));
      });

      test('Selection menu is hidden', () => {
        const list = element.shadowRoot.querySelector('.selection-options');
        assert.isTrue(list.hasAttribute('hidden'));
      });
    });

    suite('With data', () => {
      suiteSetup(() => {
        return DataGenerator.insertSavedRequestData();
      });

      suiteTeardown(() => {
        return DataGenerator.destroySavedRequestData();
      });

      let element;
      setup((done) => {
        element = fixture('Models')[2];
        doneAfterQuery(element, done);
      });

      test('hasRequests is true', () => {
        assert.isTrue(element.hasRequests);
      });

      test('empty message is not rendered', () => {
        const node = element.shadowRoot.querySelector('.empty-info');
        const display = getComputedStyle(node).display;
        assert.equal(display, 'none');
      });

      test('The list is visible', () => {
        const list = element.shadowRoot.querySelector('saved-panel-list');
        assert.isFalse(list.hasAttribute('hidden'));
      });

      test('Selection menu is visible', () => {
        const list = element.shadowRoot.querySelector('.selection-options');
        assert.isFalse(list.hasAttribute('hidden'));
      });
    });
  });
  </script>
</body>

</html>
