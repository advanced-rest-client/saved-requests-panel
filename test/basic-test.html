<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/test-helpers.js"></script>
    <script src="../../iron-test-helpers/mock-interactions.js"></script>
    <link rel="import" href="../../arc-demo-helpers/data-generator.html">
    <link rel="import" href="../saved-requests-panel.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <saved-requests-panel></saved-requests-panel>
      </template>
    </test-fixture>

    <script>
    /* global fixture, assert, DataGenerator, sinon */
    suite('basic - empty data', function() {
      var element;
      suiteSetup(function() {
        return DataGenerator.destroySavedRequestData();
      });

      setup(function(done) {
        element = fixture('basic');
        element.addEventListener('loading-changed', function handler(e) {
          if (e.detail.value) {
            return;
          }
          element.removeEventListener('loading-changed', handler);
          done();
        });
      });

      test('Items are empty', function() {
        assert.isUndefined(element.items);
      });

      test('hasItems is computed', function() {
        assert.isFalse(element.hasItems);
      });

      test('_eventSource is the element', function() {
        assert.isTrue(element === element._eventSource);
      });

      test('isSearch is false by default', function() {
        assert.isFalse(element.isSearch);
      });

      test('listHidden is computed', function() {
        assert.isTrue(element.listHidden);
      });

      test('dataUnavailable is computed', function() {
        assert.isTrue(element.dataUnavailable);
      });
    });

    suite('basic - with data', function() {
      var requests;
      var projects;
      var element;
      suiteSetup(function() {
        return DataGenerator.insertSavedIfNotExists({
          requestsSize: 1000
        })
        .then(data => {
          requests = data.requests;
          projects = data.projects;
        });
      });

      suiteTeardown(function() {
        return DataGenerator.destroySavedRequestData();
      });

      setup(function(done) {
        element = fixture('basic');
        element.addEventListener('loading-changed', function handler(e) {
          if (e.detail.value) {
            return;
          }
          element.removeEventListener('loading-changed', handler);
          done();
        });
      });

      test('Items are set', function() {
        assert.typeOf(element.items, 'array', 'Items is an array');
        assert.isAbove(element.items.length, 0, 'Items list contain data');
      });

      test('hasItems is computed', function() {
        assert.isTrue(element.hasItems);
      });

      test('listHidden is computed', function() {
        assert.isFalse(element.listHidden);
      });

      test('dataUnavailable is computed', function() {
        assert.isFalse(element.dataUnavailable);
      });

      test('_listThreshold calls the next page of the results', function(done) {
        element.addEventListener('loading-changed', function handler(e) {
          if (!e.detail.value) {
            return;
          }
          element.removeEventListener('loading-changed', handler);
          done();
        });
        element._listThreshold();
      });

      test('_loadPage increases the size of items', function() {
        var sizeBefore = element.items.length;
        return element._loadPage()
        .then(() => {
          assert.notEqual(sizeBefore, element.items.length);
        });
      });

      test('_updateQueryOptions changes queryOptions', function() {
        return element._loadPage()
        .then(() => {
          assert.equal(element.queryOptions.skip, 1);
          assert.typeOf(element.queryOptions.startkey, 'string');
        });
      });
    });

    suite('_updateQueryOptions()', function() {
      var element;
      var data;
      setup(function() {
        element = fixture('basic');
        data = {
          rows: [{
            key: 1
          }, {
            key: 2
          }]
        };
      });

      test('Updates the skip property', function() {
        assert.isUndefined(element.queryOptions.skip);
        element._updateQueryOptions(data);
        assert.equal(element.queryOptions.skip, 1);
      });

      test('Updates the startkey property', function() {
        assert.isUndefined(element.queryOptions.startkey);
        element._updateQueryOptions(data);
        assert.equal(element.queryOptions.startkey, 2);
      });
    });

    suite('_processResponse()', function() {
      var element;
      var data;
      setup(function() {
        element = fixture('basic');
        data = {
          rows: [{
            doc: {
              _id: '1',
              name: 'b'
            }
          }, {
            doc: {
              _id: '2',
              name: 'a'
            }
          }, {
            doc: {
              _id: '_design/something'
            }
          }]
        };
      });

      test('Do nothing if no response', function() {
        var result = element._processResponse();
        assert.isUndefined(result);
      });

      test('Do nothing if no rows is empty', function() {
        var result = element._processResponse({
          rows: []
        });
        assert.isUndefined(result);
      });

      test('Removes design documents', function() {
        var result = element._processResponse(data);
        assert.lengthOf(result, 2);
      });

      test('Returns a list of documents', function() {
        var result = element._processResponse(data);
        assert.typeOf(result[0]._id, 'string');
      });

      test('Documents are sorted by name', function() {
        var result = element._processResponse(data);
        assert.equal(result[0]._id, '2');
        assert.equal(result[1]._id, '1');
      });
    });

    suite('_appendItems()', function() {
      var element;
      setup(function() {
        element = fixture('basic');
      });
      suiteSetup(function() {
        return DataGenerator.destroySavedRequestData();
      });

      test('Adds items to the list that doesn\'t exists', function() {
        var items = [{
          _id: 1
        }, {
          _id: 2
        }];
        assert.isUndefined(element.items);
        element._appendItems(items);
        assert.typeOf(element.items, 'array');
        assert.lengthOf(element.items, 2);
      });

      test('Adds items to the list that already exists', function() {
        var items = [{
          _id: 1
        }, {
          _id: 2
        }];
        element.items = [{
          _id: 3
        }];
        element._appendItems(items);
        assert.typeOf(element.items, 'array');
        assert.lengthOf(element.items, 3);
      });
    });

    suite('_computeListHidden()', function() {

      var element;
      setup(function() {
        element = fixture('basic');
      });

      test('Computes false if searching', function() {
        var result = element._computeListHidden(true, true);
        assert.isFalse(result);
      });

      test('Computes false if searching and no items', function() {
        var result = element._computeListHidden(false, true);
        assert.isFalse(result);
      });

      test('Computes false if when has items', function() {
        var result = element._computeListHidden(true, false);
        assert.isFalse(result);
      });

      test('Computes true when not searching and no items', function() {
        var result = element._computeListHidden(false, false);
        assert.isTrue(result);
      });
    });

    suite('_computeSearchListEmpty()', function() {
      var element;
      setup(function() {
        element = fixture('basic');
      });

      test('True when searching, not loading, no data ', function() {
        var result = element._computeSearchListEmpty(false, false, true);
        assert.isTrue(result);
      });

      test('False for any other combination ', function() {
        var result = element._computeSearchListEmpty(true, false, true);
        assert.isFalse(result);
        result = element._computeSearchListEmpty(true, true, true);
        assert.isFalse(result);
        result = element._computeSearchListEmpty(true, true, false);
        assert.isFalse(result);
        result = element._computeSearchListEmpty(false, true, true);
        assert.isFalse(result);
        result = element._computeSearchListEmpty(false, false, false);
        assert.isFalse(result);
        result = element._computeSearchListEmpty(false, true, false);
        assert.isFalse(result);
      });
    });

    suite('_computeDataUnavailable()', function() {
      var element;
      setup(function() {
        element = fixture('basic');
      });

      test('True when not searching, not loading, no data ', function() {
        var result = element._computeDataUnavailable(false, false, false);
        assert.isTrue(result);
      });

      test('False for any other combination ', function() {
        var result = element._computeDataUnavailable(true, true, true);
        assert.isFalse(result);
        result = element._computeDataUnavailable(true, true, false);
        assert.isFalse(result);
        result = element._computeDataUnavailable(true, false, true);
        assert.isFalse(result);
        result = element._computeDataUnavailable(false, true, true);
        assert.isFalse(result);
        result = element._computeDataUnavailable(false, false, true);
        assert.isFalse(result);
        result = element._computeDataUnavailable(false, true, false);
        assert.isFalse(result);
        result = element._computeDataUnavailable(false, true, true);
        assert.isFalse(result);
      });
    });

    suite('_onOpen()', function() {
      var element;
      var event;
      setup(function() {
        element = fixture('basic');
        event = {
          detail: {
            item: {
              _id: 'test'
            }
          }
        };
      });

      test('Fires navigate event', function() {
        var spy = sinon.spy();
        element.addEventListener('navigate', spy);
        element._onOpen(event);
        assert.isTrue(spy.calledOnce);
      });

      test('navigate event is cancelable', function(done) {
        element.addEventListener('navigate', function f(e) {
          element.removeEventListener('navigate', f);
          assert.isTrue(e.cancelable);
          done();
        });
        element._onOpen(event);
      });

      test('Contains request open detail', function(done) {
        element.addEventListener('navigate', function f(e) {
          element.removeEventListener('navigate', f);
          assert.equal(e.detail.base, 'request');
          assert.equal(e.detail.type, 'saved');
          assert.equal(e.detail.id, 'test');
          done();
        });
        element._onOpen(event);
      });
    });

    suite('_prepareSaveRequestEvent()', function() {
      var element;
      var request;
      setup(function() {
        element = fixture('basic');
        request = {
          name: 'original-name',
          _id: 'original-id',
          _rev: 'original-rev',
          description: 'original-description'
        };
      });

      test('Creates a detail object', function() {
        var opts = {
          name: 'new-name'
        };
        var result = element._prepareSaveRequestEvent(opts, request);
        assert.typeOf(result.request, 'object');
        assert.typeOf(result.opts, 'object');
      });

      test('Overrides name from options', function() {
        var opts = {
          name: 'new-name'
        };
        var result = element._prepareSaveRequestEvent(opts, request);
        assert.equal(result.request.name, 'new-name');
      });

      test('Overrides description from options', function() {
        var opts = {
          name: 'new-name',
          description: 'new-desc'
        };
        var result = element._prepareSaveRequestEvent(opts, request);
        assert.equal(result.request.description, 'new-desc');
      });

      test('Removes description from request', function() {
        var opts = {
          name: 'new-name'
        };
        var result = element._prepareSaveRequestEvent(opts, request);
        assert.isUndefined(result.request.description);
      });

      test('Removes _id and _rev for save as new', function() {
        var opts = {
          name: 'new-name',
          override: false
        };
        var result = element._prepareSaveRequestEvent(opts, request);
        assert.isUndefined(result.request._id);
        assert.isUndefined(result.request._rev);
      });

      test('Adds "drive" to opts', function() {
        var opts = {
          name: 'new-name'
        };
        var result = element._prepareSaveRequestEvent(opts, request);
        assert.isFalse(result.opts.drive);
      });

      test('Removes "isDrive" from opts', function() {
        var opts = {
          name: 'new-name',
          isDrive: true
        };
        var result = element._prepareSaveRequestEvent(opts, request);
        assert.isTrue(result.opts.drive);
        assert.isUndefined(result.opts.isDrive);
      });

      test('Makes a copy of the request object', function() {
        var opts = {
          name: 'new-name'
        };
        var result = element._prepareSaveRequestEvent(opts, request);
        assert.isFalse(result.request === request);
      });
    });

    suite('_openDrive()', function() {
      var element;
      setup(function() {
        element = fixture('basic');
      });
      test('Fires pick-google-drive-item event', function() {
        var spy = sinon.spy();
        element.addEventListener('pick-google-drive-item', spy);
        element._openDrive();
        assert.isTrue(spy.calledOnce);
      });

      test('pick-google-drive-item event is cancelable', function(done) {
        element.addEventListener('pick-google-drive-item', function f(e) {
          element.removeEventListener('pick-google-drive-item', f);
          assert.isTrue(e.cancelable);
          done();
        });
        element._openDrive();
      });
    });
    </script>
  </body>
</html>
