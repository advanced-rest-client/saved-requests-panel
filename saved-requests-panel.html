<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/utils/render-status.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../bottom-sheet/bottom-sheet.html">
<link rel="import" href="../saved-request-detail/saved-request-detail.html">
<link rel="import" href="../saved-request-editor/saved-request-editor.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../requests-list-mixin/requests-list-mixin.html">
<link rel="import" href="../projects-list-consumer-mixin/projects-list-consumer-mixin.html">
<link rel="import" href="../paper-chip-input/paper-chip-input.html">
<link rel="import" href="saved-panel-list.html">
<!--
A saved requests panel for ARC.

Contains complete UI to support saved requests view.

It needs the following components to be present in the DOM to support full
functionality:

-   arc-data-export - to prepare export object
-   chrome-file-export or any other file export element to save file to disk

### Example
```
<saved-requests-panel></saved-requests-panel>
```

### Styling
`<saved-requests-panel>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--saved-requests-panel` | Mixin applied to the element | `{}`
`--arc-font-headline` | Mixin applied to the header | `{}`
`--arc-font-subhead` | Mixin applied to the subheader | `{}`
`--saved-requests-panel-loader` | Mixin applied to the loader element | `{}`
`--saved-requests-panel-list` | Mixin apllied to the list element | `{}`
`--saved-requests-panel-toast-revert-button` | Mixin appllied to the rever button in the data delete confirmation toast | `{}`
`--warning-primary-color` | Main color of the warning messages | `#FF7043`
`--warning-contrast-color` | Contrast color for the warning color | `#fff`
`--error-toast` | Mixin applied to the error toast | `{}`
`--empty-info` | Mixin applied to the label rendered when no data is available. | `{}`
`--saved-requests-panel-fab-background-color` | Color of the fab button in the details panel | `--primary-color`
`--saved-requests-panel-bottom-sheet` | Mixin apllied to the `<bottom-sheet>` elements | `{}`

@group UI Elements
@element saved-requests-panel
@demo demo/index.html
-->
<dom-module id="saved-requests-panel">
  <template>
    <style>
    :host {
      display: block;
      position: relative;
      @apply --layout-vertical;
      @apply --saved-requests-panel;
    }

    [hidden] {
      display: none !important;
    }

    .header {
      @apply --layout-horizontal;
      @apply --layout-center;
    }

    h2 {
      @apply --arc-font-headline;
      @apply --layout-flex;
    }

    h3 {
      @apply --arc-font-subhead;
    }

    paper-listbox iron-icon {
      color: rgba(0, 0, 0, 0.54);
    }

    paper-progress {
      width: 100%;
      @apply --saved-requests-panel-loader;
    }

    saved-panel-list {
      overflow: auto;
    }

    .revert-button {
      height: 38px;
      @apply --saved-requests-panel-toast-revert-button;
    }

    #dataClearDialog {
      background-color: var(--warning-primary-color, #FF7043);
      color: var(--warning-contrast-color, #fff);
    }

    #dataClearDialog paper-button {
      color: #fff;
      background-color: transparent;
    }

    .error-toast {
      background-color: var(--warning-primary-color, #FF7043);
      color: var(--warning-contrast-color, #fff);
      @apply --error-toast;
    }

    .empty-info {
      margin-left: 16px;
      font-size: 16px;
      @apply --empty-info;
    }

    .command {
      margin: 0 8px;
    }

    #requestDetailsContainer,
    #requestEditorContainer,
    #projectSelectorContainer {
      min-width: 40%;
      max-width: 60%;
      left: 20%;
      @apply --saved-requests-panel-bottom-sheet;
    }

    #requestDetailsContainer paper-fab {
      position: absolute;
      right: 16px;
      top: -28px;
    }

    #requestDetailsContainer paper-fab {
      --paper-fab-background: var(--saved-requests-panel-fab-background-color, var(--primary-color));
    }

    .project-actions {
      @apply --layout-horizontal;
      @apply --layout-end-justified;
      margin-top: 20px;
    }

    .selection-options {
      @apply --layout-horizontal;
      @apply --layout-center;
      height: 56px;
    }

    .spacer {
      @apply --layout-flex;
    }

    .project-selector-title {
      margin-left: 0;
    }
    </style>
    <div class="header">
      <h2>Saved</h2>
      <div class="header-actions">
        <paper-menu-button dynamic-align id="mainMenu">
          <paper-icon-button icon="arc:more-vert" slot="dropdown-trigger"></paper-icon-button>
          <paper-listbox slot="dropdown-content" id="mainMenuOptions">
            <paper-icon-item on-click="_onExportAll">
              <iron-icon icon="arc:archive" slot="item-icon"></iron-icon>
              Export all to file
            </paper-icon-item>
            <paper-icon-item on-click="_onExportAllDrive" data-action="export-selected-drive">
              <iron-icon icon="arc:drive-color" slot="item-icon"></iron-icon>
              Export all to Google Drive
            </paper-icon-item>
            <paper-icon-item on-click="_deleteAllClick">
              <iron-icon icon="arc:delete" slot="item-icon"></iron-icon>
              Delete all
            </paper-icon-item>
          </paper-listbox>
        </paper-menu-button>
      </div>
    </div>
    <template is="dom-if" if="[[querying]]">
      <paper-progress indeterminate></paper-progress>
    </template>
    <template is="dom-if" if="[[dataUnavailable]]">
      <p class="empty-info">The requests list is empty.</p>
      <p>Save a request using the <code class="command">[[_computeA11yButton('s')]]</code> keys on the request editor screen.</p>
    </template>


    <section class="selection-options" hidden$="[[listHidden]]">
      <p class="selection-label">Selected: [[selectedItems.length]]</p>
      <template is="dom-if" if="[[hasSelection]]">
        <paper-menu-button dynamic-align id="savedListMenu">
          <paper-icon-button icon="arc:more-vert" slot="dropdown-trigger"></paper-icon-button>
          <paper-listbox slot="dropdown-content" id="savedListMenuOptions">
            <paper-icon-item on-click="_exportSelected" data-action="export-selected-file">
              <iron-icon icon="arc:archive" slot="item-icon"></iron-icon>
              Save selected to file
            </paper-icon-item>
            <paper-icon-item on-click="_exportSelectedDrive" data-action="export-selected-drive">
              <iron-icon icon="arc:drive-color" slot="item-icon"></iron-icon>
              Save selected to Google Drive
            </paper-icon-item>
            <paper-icon-item data-action="delete-all" on-click="_deleteSelected">
              <iron-icon icon="arc:delete" slot="item-icon"></iron-icon>
              Delete selected
            </paper-icon-item>
            <paper-icon-item data-action="project-selected" on-click="_projectSelected">
              <iron-icon icon="arc:collections-bookmark" slot="item-icon"></iron-icon>
              Add selected to a project
            </paper-icon-item>
          </paper-listbox>
        </paper-menu-button>
      </template>
      <div class="spacer"></div>
      <paper-input label="search" type="search" no-label-float></paper-input>
    </section>

    <saved-panel-list
      hidden$="[[listHidden]]"
      requests="[[requests]]"
      list-type="[[listType]]"
      has-two-lines="[[_hasTwoLines]]"
      selected-items="{{selectedItems}}"
      on-list-items-threshold="loadNext"
      on-list-item-details="_onDetails"></saved-panel-list>

    <bottom-sheet id="requestDetailsContainer" on-iron-overlay-opened="_resizeSheetContent" opened="{{detailsOpened}}">
      <paper-fab icon="arc:keyboard-arrow-right" data-action="load-request-detail" title="Load request" on-click="_loadRequestDetails"></paper-fab>
      <saved-request-detail
        id="requestDetails"
        on-delete-request="_deleteRequestDetails"
        on-edit-request="_editRequestDetails"></saved-request-detail>
    </bottom-sheet>
    <bottom-sheet id="requestEditorContainer" on-iron-overlay-opened="_resizeSheetContent" opened="{{editorOpened}}">
      <saved-request-editor
        id="requestEditor"
        on-cancel-request-edit="_cancelRequestEdit"
        on-save-request="_saveRequestEdit"></saved-request-detail>
    </bottom-sheet>
    <bottom-sheet id="projectSelectorContainer">
      <h3 class="project-selector-title">Select project</h3>
      <paper-chip-input
        label="Select projects"
        value="{{selectedProjects}}"
        source="[[_computeProjectsAutocomplete(projects)]]"
        chip-remove-icon="arc:close"></paper-chip-input>
      <div class="project-actions">
        <paper-button data-action="cancel-add-project" on-click="cancelAddProject">Cancel</paper-button>
        <paper-button raised data-action="project-add" on-click="_addSelectedProject">Add</paper-button>
      </div>
    </bottom-sheet>

    <paper-toast id="noModel" class="error-toast" text="Model not found. Please, report an issue."></paper-toast>
    <paper-toast id="errorToast" class="error-toast" duration="5000"></paper-toast>
    <paper-toast id="revertError" class="error-toast" text="Unable to revert changes. Please, report an issue."></paper-toast>
    <paper-toast id="noExport" class="error-toast" text="Export module not found. Please, report an issue."></paper-toast>
    <paper-toast id="dataClearErrorToast" class="error-toast" text="Datasore delete error. Please report an issue"></paper-toast>
    <paper-toast id="requestProjectErrorToast" class="error-toast" text="Unable to update request detaile. See console for debug message."></paper-toast>
    <paper-toast id="projectDuplicateToast" class="error-toast" text="Project cannot contain duplicates. Change name of a request fires."></paper-toast>
    <paper-toast id="driveAuthRequired" class="error-toast" text="Authorization for Google Drive is required."></paper-toast>
    <paper-toast id="driveSaved" text="Requests saved on Google Drive."></paper-toast>
    <paper-toast id="deleteToast" duration="7000">
      <paper-button class="revert-button" on-click="revertDeleted">Revert</paper-button>
    </paper-toast>
    <paper-toast id="indexBuildToast" duration="0" text="Building the index is taking more time than usual. Please, wait a moment.">
      <paper-button class="revert-button" on-click="closeIndexBuildMessage">Close</paper-button>
    </paper-toast>
    <paper-dialog id="dataClearDialog" on-iron-overlay-closed="_onClearDialogResult">
      <h2>Danger zone</h2>
      <p>This will remove all data from the data store. Without option to restore it.</p>
      <p>Maybe you should create a backup first?</p>
      <div class="buttons">
        <paper-button dialog-dismiss autofocus>Cancel</paper-button>
        <paper-button dialog-confirm class="action-button">Destroy</paper-button>
      </div>
    </paper-dialog>
  </template>
  <script>
  /**
   * @polymer
   * @customElement
   * @memberof UiElements
   * @demo demo/index.html
   * @appliesMixin ArcComponents.RequestsListMixin
   * @appliesMixin ArcComponents.ProjectsListConsumerMixin
   */
  class SavedRequestsPanel extends ArcComponents.ProjectsListConsumerMixin(
    ArcComponents.RequestsListMixin(Polymer.Element)) {
    static get is() {
      return 'saved-requests-panel';
    }

    static get properties() {
      return {
        /**
         * True when the element is querying the database for the data.
         */
        querying: {
          type: Boolean,
          readOnly: true,
          notify: true
        },
        /**
         * Single page query limit.
         */
        pageLimit: {
          type: Number,
          value: 150
        },
        _queryStartKey: String,
        _querySkip: Number,
        /**
         * Computed value.
         * Database query options for pagination.
         * Use `pageLimit` to set pagination limit.
         */
        queryOptions: {
          type: Object,
          computed: '_computeQueryOptions(pageLimit, _queryStartKey, _querySkip)'
        },
        /**
         * Computed value. True if query ended and there's no results.
         */
        dataUnavailable: {
          type: Boolean,
          computed: '_computeDataUnavailable(hasRequests, querying, isSearch)'
        },
        /**
         * When set this component is in search mode.
         * This means that the list won't be loaded automatically and
         * some operations not related to search are disabled.
         */
        isSearch: {
          type: Boolean,
          value: false
        },
        /**
         * Computed value. True when the query has been performed and no items
         * has been returned. It is different from `listHidden` where less
         * conditions has to be checked. It is set to true when it doesn't
         * have items, is not loading and is search.
         */
        searchListEmpty: {
          type: Boolean,
          computed: '_computeSearchListEmpty(hasRequests, loading, isSearch)'
        },
        /**
         * When set it won't query for data automatically when attached to the DOM.
         */
        noAuto: Boolean,
        /**
         * List of requests that has been recently removed
         */
        _latestDeleted: Array,
        /**
         * Computed value, true if the requests lists is hidden.
         */
        listHidden: {
          type: Boolean,
          value: true,
          computed: '_computeListHidden(hasRequests, isSearch)'
        },
        /**
         * Selected items list.
         * @type {Array<Object>}
         */
        selectedItems: Array,
        /**
         * Computed value, true when the user made a selection on the list.
         */
        hasSelection: {type: Boolean, computed: '_computeHasSelection(selectedItems.length)'},
        /**
         * When true the editor panel is rendered
         */
        editorOpened: Boolean,
        /**
         * When true the details panel is rendered
         */
        detailsOpened: Boolean,
        /**
         * List of selected in the dialog project names.
         * @type {Array<String>}
         */
        selectedProjects: Array
      };
    }
    constructor() {
      super();
      this._navigateHandler = this._navigateHandler.bind(this);
      this._searchHandler = this._searchHandler.bind(this);
      this._dataImportHandler = this._dataImportHandler.bind(this);
      this._onDatabaseDestroy = this._onDatabaseDestroy.bind(this);
    }

    connectedCallback() {
      if (!this.type) {
        this.type = 'saved';
      }
      super.connectedCallback();
      window.addEventListener('data-imported', this._dataImportHandler);
      window.addEventListener('datastore-destroyed', this._onDatabaseDestroy);
      if (!this.noAuto && !this.querying && !this.requests) {
        this.loadNext();
      }
      this.addEventListener('navigate', this._navigateHandler);
      const input = this.shadowRoot.querySelector('paper-input[type="search"]');
      input.inputElement.addEventListener('search', this._searchHandler);
    }

    disconnectedCallback() {
      super.disconnectedCallback();
      window.removeEventListener('data-imported', this._dataImportHandler);
      window.removeEventListener('datastore-destroyed', this._onDatabaseDestroy);
      const input = this.shadowRoot.querySelector('paper-input[type="search"]');
      input.inputElement.removeEventListener('search', this._searchHandler);
      this.removeEventListener('navigate', this._navigateHandler);
    }
    /**
     * Computes pagination options.
     * This resets pagination status.
     * @param {Number} limit Items per page limit.
     * @param {String} startKey Query start key
     * @param {Number} skip Number of records to skip.
     * @return {Object} Pagination options for PouchDB.
     */
    _computeQueryOptions(limit, startKey, skip) {
      const result = {
        limit,
        descending: true,
        // jscs:disable
        include_docs: true
        // jscs:enable
      };
      if (startKey) {
        result.startkey = startKey;
      }
      if (skip) {
        result.skip = skip;
      }
      return result;
    }

    /**
     * Computes value for the `dataUnavailable` proeprty
     * @param {Boolean} hasRequests [description]
     * @param {Booelan} loading [description]
     * @param {Boolean} isSearch [description]
     * @return {Boolean}
     */
    _computeDataUnavailable(hasRequests, loading, isSearch) {
      return !isSearch && !loading && !hasRequests;
    }

    /**
     * Computes value for the `searchListEmpty` property
     * @param {Boolean} hasRequests [description]
     * @param {Booelan} loading [description]
     * @param {Boolean} isSearch [description]
     * @return {Boolean}
     */
    _computeSearchListEmpty(hasRequests, loading, isSearch) {
      return !!isSearch && !loading && !hasRequests;
    }
    /**
     * Notifies the list that the resize event occurred.
     * Should be called whhen content of the list changed but the list wasn't
     * visible at the time.
     */
    notifyResize() {
      const list = this.shadowRoot.querySelector('saved-panel-list');
      if (list) {
        list.notifyResize();
      } else {
        console.warn('saved-panel-list not in the DOM');
      }
    }
    /**
     * Computes value of the `listHidden` property.
     * List is hidden when no requests are found and it is not searching.
     * @param {Boolean} hasRequests
     * @param {Boolean} isSearch
     * @return {Boolean}
     */
    _computeListHidden(hasRequests, isSearch) {
      if (isSearch) {
        return false;
      }
      return !hasRequests;
    }
    /**
     * Handler for navigate action from the list
     */
    _navigateHandler() {
      if (this.detailsOpened) {
        this.detailsOpened = false;
      }
    }

    /**
     * Refreshes the data from the datastore.
     * It resets the query options, clears requests and makes a query to the datastore.
     */
    refresh() {
      this.reset();
      this.loadNext();
    }
    /**
     * Resets the state of the variables.
     */
    reset() {
      if (this._queryStartKey) {
        this._queryStartKey = undefined;
      }
      if (this._querySkip) {
        this._querySkip = undefined;
      }
      if (this.isSearch) {
        this.isSearch = false;
      }
      if (this.querying) {
        this._setQuerying(false);
      }
      if (this.requests) {
        this.set('requests', undefined);
      }
    }

    /**
     * Handler for `data-imported` cutom event.
     * Refreshes data state.
     */
    _dataImportHandler() {
      this.refresh();
    }
    /**
     * Handler for the `datastore-destroyed` custom event.
     * If one of destroyed databases is saved store then it refreshes the sate.
     * @param {CustomEvent} e
     */
    _onDatabaseDestroy(e) {
      let datastore = e.detail.datastore;
      if (!datastore || !datastore.length) {
        return;
      }
      if (typeof datastore === 'string') {
        datastore = [datastore];
      }
      if (datastore.indexOf('saved-requests') === -1 &&
        datastore.indexOf('saved') === -1 &&
        datastore[0] !== 'all') {
        return;
      }
      this.refresh();
    }
    /**
     * Loads next page of results. It runs the task in a debouncer set to
     * next render frame so it's safe to call it more than once at the time.
     */
    loadNext() {
      if (this.isSearch) {
        return;
      }
      if (this.__makingQuery) {
        return;
      }
      this.__makingQuery = true;
      Polymer.RenderStatus.afterNextRender(this, () => {
        this.__makingQuery = false;
        this._loadPage();
      });
    }
    /**
     * Appends array items to the `requests` property.
     * It should be used instead of direct manipulation of the `items` array.
     * @param {Array<Object>} requests List of requests to appenmd
     */
    _appendItems(requests) {
      if (!requests || !requests.length) {
        return;
      }
      const existing = this.requests;
      if (!existing) {
        this.set('requests', requests);
        return;
      }
      requests.forEach((item) => this.push('requests', item));
    }
    /**
     * Loads next page of results from the datastore.
     * Pagination used here has been described in PouchDB pagination strategies
     * document.
     * @return {Promise}
     */
    _loadPage() {
      if (this.isSearch) {
        return Promise.resolve();
      }
      const e = this._dispatchListEvent();
      if (!e.defaultPrevented) {
        let msg = 'Request model not found.';
        console.warn(msg);
        return Promise.reject(new Error(msg));
      }
      this._setQuerying(true);
      return e.detail.result
      .then((response) => {
        this._setQuerying(false);
        if (response && response.rows.length > 0) {
          // Set up pagination.
          this._queryStartKey = response.rows[response.rows.length - 1].key;
          if (!this._querySkip) {
            this._querySkip = 1;
          }
          const res = this._processRequestsResponse(response.rows);
          this._appendItems(res);
          Polymer.RenderStatus.afterNextRender(this, () => {
            if (this.notifyResize) {
              this.notifyResize();
            }
          });
        }
      })
      .catch((error) => {
        this._setQuerying(false);
        this._handleError(error);
      });
    }
    /**
     * Dispatches `request-list` custom event and returns the event.
     * @return {CustomEvent}
     */
    _dispatchListEvent() {
      const e = new CustomEvent('request-list', {
        cancelable: true,
        composed: true,
        bubbles: true,
        detail: {
          queryOptions: this.queryOptions,
          type: 'saved'
        }
      });
      this.dispatchEvent(e);
      return e;
    }

    _handleError(cause) {
      if (this.querying) {
        this._setQuerying(false);
      }
      console.warn('[Saved list error]', cause);
      throw cause;
    }

    /**
     * Prepares data to display in the view.
     *
     * @param {Object} items List of documents returned by the model.
     * @return {Array} List of request to be passed to the list view.
     */
    _processRequestsResponse(items) {
      if (!items || !items.length) {
        return;
      }
      const list = [];
      items.forEach((item) => {
        if (!item) {
          return;
        }
        if (item.doc) {
          item = item.doc;
        }
        if (item._id.indexOf('_design') !== 0) {
          list[list.length] = item;
        }
      });
      list.sort(this._sortFn);
      return list;
    }
    /**
     * Sorts the query results by `updated` property.
     * @param {Object} a
     * @param {Object} b
     * @return {Number}
     */
    _sortSavedResults(a, b) {
      if (!a.name) {
        return -1;
      }
      if (!b.name) {
        return 1;
      }
      if (!a.name && !b.name) {
        return 0;
      }
      return a.name.localeCompare(b.name);
    }
    /**
     * Opens the request details applet with the request.
     * @param {CustomEvent} e
     */
    _onDetails(e) {
      this.$.requestDetails.request = e.detail.request;
      this.detailsOpened = true;
    }
    /**
     * Fires `navigate` event for currently loaded in the details request.
     */
    _loadRequestDetails() {
      this.dispatchEvent(new CustomEvent('navigate', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {
          base: 'request',
          type: this.type,
          id: this.$.requestDetails.request._id
        }
      }));
      this.detailsOpened = false;
    }

    _searchHandler(e) {
      const {value} = e.target;
      this.query(value);
    }
    /**
     * Dispatches `request-query` custom event to `request-model`
     * to perform a query.
     *
     * @param {String} query The query to performs. Pass empty stirng
     * (or nothing) to reset query state.
     * @return {Promise} Resolved promise when the query ends.
     */
    query(query) {
      if (!query) {
        if (this.isSearch) {
          this.refresh();
        }
        return Promise.resolve();
      }
      this.isSearch = true;
      this._setQuerying(true);
      this.set('requests', undefined);
      query = this._prepareQuery(query);
      const e = this._dispatchQueryEvent(query);
      if (!e.defaultPrevented) {
        const msg = 'Model not found.';
        console.warn(msg);
        return Promise.reject(new Error(msg));
      }
      return e.detail.result
      .then((result) => {
        result = this._processRequestsResponse(result);
        this._appendItems(result);
        this._setQuerying(false);
      })
      .catch((error) => {
        this._setQuerying(false);
        this._handleError(error);
      });
    }
    /**
     * Dispatches `request-query` custom event.
     * This event is handled by `request-mode` element to query the
     * datastore for user search term.
     * @param {String} q Query passed to event detail.
     * @return {CustomEvent}
     */
    _dispatchQueryEvent(q) {
      const e = new CustomEvent('request-query', {
        cancelable: true,
        bubbles: true,
        composed: true,
        detail: {
          q,
          type: 'saved'
        }
      });
      this.dispatchEvent(e);
      return e;
    }

    _prepareQuery(query) {
      query = String(query);
      query = query.toLowerCase();
      if (query[0] === '_') {
        query = query.substr(1);
      }
      return query;
    }
    // Handles items delete event.
    _deleteSelected() {
      this._closeSelectionMenu();
      const data = this.selectedItems;
      if (!data.length) {
        return;
      }
      return this._delete(data);
    }
    // Deletes a request from the details panel.
    _deleteRequestDetails() {
      const data = [this.$.requestDetails.request];
      this.detailsOpened = false;
      return this._delete(data);
    }
    /**
     * Performs a delete action of request items.
     *
     * @param {Array<Object>} deleted List of deleted items.
     * @return {[type]} [description]
     */
    _delete(deleted) {
      const e = new CustomEvent('request-objects-deleted', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {
          type: 'saved',
          items: deleted.map((item) => item._id)
        }
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        this.$.noModel.opened = true;
        return;
      }
      return e.detail.result
      .then((updated) => {
        return Object.keys(updated)
        .map((id) => {
          return {
            _id: id,
            _rev: updated[id]
          };
        });
      })
      .then((deleted) => {
        this._latestDeleted = deleted;
        let msg;
        if (deleted.length === 1) {
          msg = 'The request has been removed.';
        } else {
          msg = deleted.length + ' requests has been removed.';
        }
        this.$.deleteToast.text = msg;
        this.$.deleteToast.opened = true;
      });
    }
    /**
     * Restores removed requests.
     * It does nothing if `_latestDeleted` is not set or empty.
     *
     * @return {Promise} A promise resolved when objects were restored
     */
    revertDeleted() {
      this.$.deleteToast.opened = false;
      const deleted = this._latestDeleted;
      if (!deleted || !deleted.length) {
        return Promise.resolve();
      }
      const e = new CustomEvent('request-objects-undeleted', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {
          type: 'saved',
          items: deleted
        }
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        this.$.noModel.opened = true;
        return Promise.reject(new Error('Model not found'));
      }
      return e.detail.result
      .catch((cause) => {
        this.$.revertError.opened = true;
        this._handleError(cause);
      });
    }
    /**
     * Forces selection menu to close.
     */
    _closeSelectionMenu() {
      const menu = this.shadowRoot.querySelector('#savedListMenu');
      if (!menu) {
        console.warn('Menu not found in the DOM');
        return;
      }
      menu.opened = false;
      const options = this.shadowRoot.querySelector('#savedListMenuOptions');
      if (!options) {
        console.warn('Options menu not found in the DOM');
        return;
      }
      options.selected = -1;
    }
    /**
     * Calles `_exportItems()` with default destination (`file`)
     */
    _exportSelected() {
      this._exportItems('file');
    }
    /**
     * Calles `_exportItems()` with destination set to `drive`
     */
    _exportSelectedDrive() {
      this._exportItems('drive');
    }
    /**
     * Forces main menu to close.
     */
    _closeMainMenu() {
      this.$.mainMenu.opened = false;
      this.$.mainMenuOptions.selected = -1;
    }
    /**
     * Menu handler to export all project data to Drive
     */
    _onExportAllDrive() {
      this._closeMainMenu();
      this._exportAll('drive');
    }
    /**
     * Menu handler to export all project data to file
     */
    _onExportAll() {
      this._closeMainMenu();
      this._exportAll('file');
    }
    /**
     * Requests application to export all data to `destination`.
     * This works with `arc-data-export` element.
     *
     * @param {String} destination One of the supporting destinations
     * in `arc-data-export`.
     */
    _exportAll(destination) {
      const e = new CustomEvent('export-data', {
        cancelable: true,
        composed: true,
        bubbles: true,
        detail: {
          type: 'arc-export',
          destination,
          file: 'arc-saved-export.json',
          data: {
            saved: true
          }
        }
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        this.$.noExport.opened = true;
        return;
      }
      e.detail.result.then(() => {
        if (destination === 'drive') {
          this.$.driveSaved.opened = true;
        }
      });
    }
    /**
     * Dispatches the `export-project` event with relevant data.
     *
     * @param {String} destination
     */
    _exportItems(destination) {
      this._closeSelectionMenu();
      const data = this.selectedItems;
      if (!data.length) {
        return;
      }
      const e = new CustomEvent('export-data', {
        cancelable: true,
        composed: true,
        bubbles: true,
        detail: {
          type: 'arc-export',
          destination,
          file: 'arc-saved-export.json',
          kind: 'ARC#SavedExport',
          data: {
            saved: data
          }
        }
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        this.$.noExport.opened = true;
        return;
      }
      e.detail.result.then(() => {
        if (destination === 'drive') {
          this.$.driveSaved.opened = true;
        }
      });
    }
    /**
     * Handler for delete all menu option click.
     */
    _deleteAllClick() {
      this.$.mainMenu.opened = false;
      this.$.mainMenuOptions.selected = -1;
      this.$.dataClearDialog.opened = true;
    }
    /**
     * Called when delete datastore dialog is closed.
     * @param {CustomEvent} e
     */
    _onClearDialogResult(e) {
      if (!e.detail.confirmed) {
        return;
      }
      this._clearDatastore();
    }
    /**
     * Removes all data from the datastore and then fires
     */
    _clearDatastore() {
      const e = new CustomEvent('destroy-model', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {
          models: ['saved']
        }
      });
      this.dispatchEvent(e);
      if (!e.detail.result) {
        this.$.dataClearErrorToast.opened = true;
        this._handleError(new Error('Model not found.'));
        return;
      }
      Promise.all(e.detail.result)
      .catch((cause) => {
        this.$.dataClearErrorToast.opened = true;
        this._handleError(cause);
      });
    }
    /**
     * Opens request details editor in place of the request details applet.
     */
    _editRequestDetails() {
      const request = Object.assign({}, this.$.requestDetails.request);
      this.$.requestEditor.request = request;
      this.$.requestDetails.request = undefined;
      this.detailsOpened = false;
      this.editorOpened = true;
    }

    _resizeSheetContent(e) {
      const panel = e.target.querySelector(
          'saved-request-editor,saved-request-detail');
      if (panel && panel.notifyResize) {
        panel.notifyResize();
      }
    }

    _cancelRequestEdit() {
      this.editorOpened = false;
    }
    /**
     * Handler fro save request event from the editor.
     */
    _saveRequestEdit() {
      this.editorOpened = false;
      this.$.requestEditor.request = undefined;
    }

    _computeHasSelection(length) {
      return !!length;
    }
    /**
     * Computes a proper key command depending on the platform.
     *
     * @param {String} key The key modifier for the command
     * @return {String} Keyboard command for the key.
     */
    _computeA11yButton(key) {
      const isMac = navigator.platform.indexOf('Mac') !== -1;
      let cmd = '';
      if (isMac) {
        cmd += 'meta+';
      } else {
        cmd += 'ctrl+';
      }
      cmd += key;
      return cmd;
    }
    /**
     * Handles menu click for adding selected requests to a project.
     */
    _projectSelected() {
      this._closeSelectionMenu();
      const requests = this.selectedItems;
      if (!requests || !requests.length) {
        return;
      }
      this.$.projectSelectorContainer.opened = true;
    }
    /**
     * Cancels adding to project dialog.
     */
    cancelAddProject() {
      this.$.projectSelectorContainer.opened = false;
    }
    /**
     * Updates requests objects with projects ids.
     * @param {Array<Object>} requests List of requests to update
     * @param {Array<String>} ids List of project IDs.
     * @return {Array<Object>}
     */
    _updateRequestsProjects(requests, ids) {
      requests.forEach((item) => {
        if (!item.projects) {
          item.projects = [];
        }
        if (item.legacyProject) {
          if (item.projects.indexOf(item.legacyProject) === -1) {
            item.projects[item.projects.length] = item.legacyProject;
          }
          delete item.legacyProject;
        }
        item.projects = item.projects.concat(ids);
      });
      return requests;
    }
    /**
     * Adds selected requests to a project.
     * @return {Promise}
     */
    _addSelectedProject() {
      this.$.projectSelectorContainer.opened = false;
      const requests = this.selectedItems;
      if (!requests) {
        throw new Error('Something is wrong...');
      }
      const info = this._processSelectedProjectsInfo(this.selectedProjects);
      let p;
      if (info.add.length) {
        p = this._createProjects(info.add, requests.map((i) => i._id));
      } else {
        p = Promise.resolve();
      }
      return p
      .then((created) => this._prepareProjectsIdsList(created, info.existing))
      .then((projectIds) => this._updateRequestsProjects(requests, projectIds))
      .then((requests) => {
        const e = new CustomEvent('request-objects-changed', {
          bubbles: true,
          composed: true,
          cancelable: true,
          detail: {
            type: 'saved',
            requests
          }
        });
        this.dispatchEvent(e);
        if (!e.defaultPrevented) {
          this.$.noModel.opened = true;
          return Promise.reject(new Error('Model not found'));
        }
        return e.detail.result;
      })
      .catch((cause) => {
        this.$.requestProjectErrorToast.opened = true;
        throw cause;
      });
    }
    /**
     * Dispatches `project-update-bulk` custom event and returns event's
     * promise.
     * @param {Array<String>} names List of names.
     * @param {Array<String>} requestIds List of request IDs to associate with the project.
     * @return {Promise<Array<Object>>}
     */
    _createProjects(names, requestIds) {
      const projects = names.map((name) => {
        return {
          name,
          requests: requestIds
        };
      });
      const e = new CustomEvent('project-update-bulk', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {
          projects
        }
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        return Promise.reject('The project-model is not in the DOM.');
      }
      return e.detail.result;
    }

    _prepareProjectsIdsList(created, ids) {
      ids = ids || [];
      if (!created || !created.length) {
        return ids;
      }
      const createdIds = created.map((item) => item._id);
      return ids.concat(createdIds);
    }
  }
  window.customElements.define(SavedRequestsPanel.is, SavedRequestsPanel);
  </script>
</dom-module>
